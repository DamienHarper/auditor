# Upgrading to 4.x from 3.x

This document describes the backward incompatible changes introduced in auditor 4.0 and how to adapt your code.

## Requirements Changes

### PHP Version

**Minimum PHP version is now 8.4** (was 8.2 in 3.x)

This is required by Symfony 8.0 and leverages PHP 8.4 features.

### Symfony Version

**Minimum Symfony version is now 8.0** (was 5.4 in 3.x)

Support for Symfony 5.4, 6.4, and 7.x has been dropped.

### Doctrine Versions

| Package        | 3.x Version | 4.x Version |
|----------------|-------------|-------------|
| Doctrine DBAL  | >= 3.2      | >= 4.0      |
| Doctrine ORM   | >= 2.13     | >= 3.2      |

### PHPUnit Version

**PHPUnit minimum version is now 12.0** (was 11.0 in 3.x)

## Removed Methods

### DoctrineHelper

The following methods have been removed from `DH\Auditor\Provider\Doctrine\Persistence\Helper\DoctrineHelper`:

| Removed Method                            | Replacement                              |
|-------------------------------------------|------------------------------------------|
| `DoctrineHelper::createSchemaManager()`   | `$connection->createSchemaManager()`     |
| `DoctrineHelper::introspectSchema()`      | `$schemaManager->introspectSchema()`     |
| `DoctrineHelper::getMigrateToSql()`       | See migration example below              |

These methods were compatibility shims for older Doctrine DBAL versions that are no longer needed.

### Migration Example: getMigrateToSql

**Before (3.x):**

```php
use DH\Auditor\Provider\Doctrine\Persistence\Helper\DoctrineHelper;

$sqls = DoctrineHelper::getMigrateToSql($connection, $fromSchema, $toSchema);
```

**After (4.0):**

```php
use Doctrine\DBAL\Schema\Comparator;

$platform = $connection->getDatabasePlatform();
$sqls = $platform->getAlterSchemaSQL(
    (new Comparator($platform))->compareSchemas($fromSchema, $toSchema)
);
```

### DoctrineHelper::getRealClassName()

This method now only handles `__CG__` proxies (Doctrine Common Gateway marker).

With PHP 8.4+, Doctrine ORM uses native lazy objects instead of proxy classes, so the previous proxy handling logic has been simplified.

## Composer Scripts Changes

The following composer scripts have been removed:

| Removed Script | Purpose                |
|----------------|------------------------|
| `setup5`       | Symfony 5.4 setup      |
| `setup6`       | Symfony 6.4 setup      |
| `setup7`       | Symfony 7.x setup      |

Use the new unified `setup` script instead:

```bash
composer setup
```

## Internal Changes

These changes are internal and should not affect most users, but are documented for completeness:

### DoctrineHelper::setPrimaryKey()

Now uses `PrimaryKeyConstraint` directly without fallback to deprecated `setPrimaryKey()` method.

### DoctrineHelper::getReflectionPropertyValue()

Now uses `getPropertyAccessor()` directly without fallback to deprecated `getReflectionProperty()` method.

### PlatformHelper::getServerVersion()

Simplified to use `getNativeConnection()` directly. The `getWrappedConnection()` fallback has been removed.

## Migration Steps

### 1. Update PHP Version

Ensure you're running PHP 8.4 or higher:

```bash
php -v
# PHP 8.4.x ...
```

### 2. Update Symfony Dependencies

Update your `composer.json`:

```json
{
    "require": {
        "symfony/framework-bundle": "^8.0"
    }
}
```

### 3. Update Doctrine Dependencies

```json
{
    "require": {
        "doctrine/dbal": "^4.0",
        "doctrine/orm": "^3.2"
    }
}
```

### 4. Update auditor

```bash
composer require damienharper/auditor:^4.0
```

### 5. Update Your Code

Replace any removed method calls:

```php
// Before
$schemaManager = DoctrineHelper::createSchemaManager($connection);
$schema = DoctrineHelper::introspectSchema($schemaManager);

// After
$schemaManager = $connection->createSchemaManager();
$schema = $schemaManager->introspectSchema();
```

### 6. Run Tests

```bash
./vendor/bin/phpunit
```

### 7. Update Audit Schema

After upgrading, ensure your audit tables are up to date:

```bash
php bin/console audit:schema:update --dump-sql
php bin/console audit:schema:update --force
```

## Troubleshooting

### "Class not found" errors

Ensure all dependencies are updated:

```bash
composer update
```

### Schema issues

Run the schema update command:

```bash
php bin/console audit:schema:update --force
```

### Test failures

If tests fail after upgrading:

1. Check PHPUnit version compatibility
2. Review any mocked classes for API changes
3. Check for deprecated method usage

## Need Help?

If you encounter issues during the upgrade:

1. Check the [GitHub Issues](https://github.com/DamienHarper/auditor/issues)
2. Review the [Release Notes](https://github.com/DamienHarper/auditor/releases)
3. Open a new issue with:
   - PHP version
   - Symfony version
   - Error messages
   - Steps to reproduce
